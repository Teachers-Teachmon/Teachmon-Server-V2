package solvit.teachmon.domain.management.student.domain.repository.querydsl.impl;

import com.querydsl.jpa.impl.JPAQueryFactory;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;
import solvit.teachmon.domain.management.student.domain.repository.querydsl.StudentQueryDslRepository;
import solvit.teachmon.domain.management.student.presentation.dto.response.QStudentSearchResponseDto;
import solvit.teachmon.domain.management.student.presentation.dto.response.StudentSearchResponseDto;

import java.util.List;

import static solvit.teachmon.domain.management.student.domain.entity.QStudentEntity.studentEntity;

@Repository
@RequiredArgsConstructor
public class StudentRepositoryImpl implements StudentQueryDslRepository {
    private final JPAQueryFactory queryFactory;

    @Override
    public List<StudentSearchResponseDto> searchStudentsByKeyword(String keyword) {
        if (keyword == null || keyword.trim().isEmpty()) {
            return queryFactory.select(
                    new QStudentSearchResponseDto(
                            studentEntity.id,
                            studentEntity.grade,
                            studentEntity.classNumber,
                            studentEntity.number,
                            studentEntity.name
                    )
            )
            .from(studentEntity)
            .fetch();
        }
        
        String trimmedKeyword = keyword.trim();
        
        return queryFactory.select(
                new QStudentSearchResponseDto(
                        studentEntity.id,
                        studentEntity.grade,
                        studentEntity.classNumber,
                        studentEntity.number,
                        studentEntity.name
                )
        )
        .from(studentEntity)
        .where(studentEntity.grade.stringValue()
                .concat(studentEntity.classNumber.stringValue())
                .concat(studentEntity.number.stringValue())
                .concat(" ")
                .concat(studentEntity.name)
                .containsIgnoreCase(trimmedKeyword))
        .fetch();
    }
}